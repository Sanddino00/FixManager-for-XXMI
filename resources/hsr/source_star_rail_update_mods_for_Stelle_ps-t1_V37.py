# Made by Sora_
# Thanks to the Genshin Impact Modding Community for their help and support

# Fixes for Stelle

# ##########################################################################################################################
#     ................                .... ..   ..               ............. ............                              
#     ................                ... ...                    .........................                               
#   ..............            ....                 ..            ........,]`.]............                               
# ................            ......                             ...,/\]/O],*,[\[]........                               
# ............                                           ........,/\@O@/,/\]]],`=`*,=\`...........                       
# .......... .        ..                                 ....../@\@@/`/*`,/\/\[,*,,**=OO]]]........                      
# ............                                        .. ..../O\O@[,,,///`********,*`,]\]*/\`.....                       
# ...........  ...                                    .. .../O@@^*,/\/`*/\***********,**/*/\/.....                       
# ............. .... .                     .  ............][\ooo\O\@^]/ooo`****,*****`*`^`/O@O..... ..                .. 
# ............. .... .                   ............,O\OOO\oo]OOo@`@OO//`***,\\,,``/^,\^,***[\....                      
# ............                            .............,//*,*]/oO^\@ooooo/^*]\]/`\*//**=**`[^*/^...                      
# ............                            ...=]]]]]/[**`*,,*/\o@`O@O/OO\=O/[O\``[/^/``*O]`**,^\\....                     
# ............ ...                       ......,OooooO/@@/o\[//=@o@o//,OOO/\//*/\OO\]`=\^*O]/@@\^..       .. .           
# ............    ..                      ........[@O\oooo\O@/@OOO\///O/\\@^]@\OOO\\\oOO^\@o]OO\^..       .. .           
# .......... .....    ..      .  .       ............/oo/\/,\@O@O@\OO\^]]@@/\,\//`=OO\O@^@O/=\\OO`....        ..         
# ..... ....... ..... .       ....        .........,//O[[]OOOOOO/O/@@@@@@\/]o\OO`=O@\=OO/O/,=/^@@@....        ..         
# ................            .....  .............=\`*`/\OOooO/@/@,O@@@@O^,@\OO*=O@\*oOOOO^=^/@/@,\... ..         .......
# ................            ....        ......,//*,/OOOoO\=/OOo^\\.\O/.../O//\/@\O\@@\OO*@\O=\@..=.....         ....   
# ................                    ........,/,/,//OO\/*,*@oOO\^O@......*O/`.**\@@@^@@@^/\O^**=^........               
# ...,]/\]].....                      .....]\\*/O\@oo\/,`*/@Oo/@o^=^.....,.......@O@`/@@^@/oO`\OO^... .                  
# .,/`@O[*............................,]/^**/@O/OOOO``*,\o@O/\OO/^=\..........[...,.*@O@@OO@,*/=/..                      
# O,[,`\]/[\/OOO\/^[*,\/**,]]]]]]O\Oo\,*,/OO@@oOO`**,*,oO\/*@@@@/o,@\`..............@O@Oo@@`*/./...                      
# \,/[,*`,\//@//oo\O]*,\`..\/**`,Oo/[OOo@O@\O/\//o\,`\//[*//@@@O@o`@^@`.[,......../@\@OO@@*=`......                      
# O/@//\`*/**[\/\OO\@\\`\[\..\][\/@OO\OO^OO/]o/o/o\[/\*,/O/\@@@\O@O@,/@\.`..,]/@@OOO@@o@@/`.......                       
# \/...,,[[\`*,*\\\/O[@.,//*./OOOO@@@OO@Ooo\o\@/\[,*\,OO@oo@@@@@O@@@=@@@@@@@@OO@=@@@OOO\O^.. ... .                       
# .......*``],,``/\O]*/..\\^=\/oOo///\oOOOOO\]`*/`/]OO/oOO\O@@@@@@@@@@@@@@@@@O@@@@O\O@OO=^...     .. .                   
# .../\\\\\=\/O\/[^\`=/...`.@\],/O`**\]`oooooo^O@\oo\@O@OOOOOOOO@@@@/@@@@@@@@@@\OO@@@/\/=.......  ..                     
# ./OooooOO/^/^***/\,/@`....@/`,,*`*`*/]]O/@//ooOOO/@@@@O\OOOOOOOOOOOO@O]\@@@@O@@@@@@OO@OO^......         ....           
# OooO/@\o\/*`******/@O^....@.*`*`***]/@@OOOOOOO/O@@OO\@@@@OOOOOO@@OO@OOOO@@@@@OOO@@@@@O@@O^.......               ....   
# OOO\Oo\/**`**,**\]`@,=^**//\\/\\\`O\oO@/`/@O\@@OOOOOOOO@@@@OOO/@@@@@@@OOO@@@@OOOOO@@@@@@@O\..  .                . ..   
# OOOOO@[,,*`]/Oooooo\Ooo\oo/O`/\@*[,[O@/O\OOO@@OOOOOO@OOOO@@@@OOOOO@@@@@O@@@/@\@@[OOOOO@@@@OO`...         .......       
# OOOo/*`,,@oooo\oooo\//@\oo/O\//,\@OooOOOoo@O@OOOOO@@O@@@@@@@O@OOOOOO@@\\@@OO\OO@@`\/OOO\@@OO@...          . ....       
# OOo@*``/\/[.......,.==@@OO/OO\/\^OO/@\OoO\@@@@@@@@@@@@@@@@@\@@@@@OOO@@@/@@OOOOO@@@@@OOOOOO@OO^...       ....           
# OOOO,,/............^,@@O\@^@O/\//OO@@@@@@@@@@@@@@@@OOO/OOOOOO@O\@OOO@@@@@O]]\]]/O@\OOOOOOOOO@O...         ..           
# =OO/.................@@OO@@@=]oo^OOO@@@@@OOOOOO/OO@O@@@@\OOOOOO@@@@/OOOOOO@@@@@@@@@@@OO@@@@@@@^.                       
# ............,\O`.....,@O@@@OO@/\/OOOOO@@@OOOOOOOOOOOO@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@^.                       
# ............/@^........\/OOOOOO@@O/OOO@@OOOOOOOOOOOOOOOOOO\@O@@@@@@@@@@@@@@@@@@@@@@@@OOOOOO@@@^.                       
# .. ... .....^*,].........\@O/@@@@@@@@@@@@@@@@@@OOOo/O@@@@@@O/o@@@@@@@@@@@@@@@OO@@@@@@@OOOOOOO@^.              ..       
# ............\,***[].......=@@@@@@@@@@@@@@@@@@@@@@@@@@@@@OOOOOoO\@@@@@@@@OO@O@OOOOOOO@@OOOOO@@@^.  ..        ......     
# ... .........\,***,*[`......@oO@@@@@@@@@@@@@@@@@@@@@@\/OOoO/O/`*\@@@@@@@OOOOO@OOOOOOO\\OOOOOO@^..   ...       ..   .   
# ....... .......\\,*``*,[]...,@OO@@@@@@@@@@@@@@@@@@[ooooo@/^*]/O\/\@@@@@OOOO@@@OOOOOOOOOO@OOOOO\..               ....   
# .................,@@]*^,,*``**,\\@@@@@@@@@@@@@/@\oOO[]]/@\oooooooo\@@@@O@OOO@@O@@@OO\OOO@@OOOO@..               ...... 
# ....    ............[@//]]`****]\]/@@@@@@@@@O@OOOooooooooooooOooO@\\/@@@@@@@OO/@@@@@@@@@OOOOOOO\....                   
# ....  .... .... .......,\Oo//[]*^ooooooo\/@@ooOoooooOoooooOoO/`.//ooO\@@@@@@@/O@OO/@@@@@@@/OOOOO^...                   
# .. ...  ....    ..   ......[\[`/=/oooooOooooooooOOOoo/OO[`...,/Ooo\\/./@@@@@@@@@OOOO\\@@@@@@@O@@@.....                  
# ......  ....           ........[\O/[[[[[OO[[[[[\O/[`.......,O/\ooO`..=OO@@@@@@@@@OOOOOOOO@\@OO@@@@.... .               
# ....    ....           .........,/\\......................///O/`......=@@@@@@@@@@OOOOOOOOOO@OO\@@@^.....               
# ....       .            .........*=....................,[///`.........=@@@@@@@@@@OOOOOOOOOOO@O@@@@@.....               
# ...... .                  ..   ...\\................,/][`.......... ..@@@@@@@@@@@@OOOOO@@@O\@@@@@@@@....               
# ........                        ....\`.........]/OO[`.......  .......=@@@@@@@@@@@@@@@O@@@@@@@@@@@@@@^...               
# . .... .... ....              ...........[`.............      .......@@@@@@@/OOO@@@@@@@@@@@@@@/@@@O@@^..               
#   ......... ...             .   ..... ..................        ...,/@@@@@@@OOOOO/@@@@@@@OOO@@@@@OOOO@`.               
#   ........  ....                    .    ......   ................/@@@@@@@@@@OOO@OOO@@@@@OOOOO@@@OOOOO@.........       
# .   .....   ....                        .. ..  .         .. ..../@@@@@@@@@@@@@@O@@@@@@@@@@@@/O/@@OOOOOOO/`.... ..      
#    ...    ..           .                                ....../OOO@@@@@@@@@@@@@O@@@@@@@@@@@@@@@=@@OOOO\/O/\.....       
#    .... .           ....                               ...../@OOOOOO@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@OOOO\//O\\.....      
# ........        ...... .                .           ....../@OOOOOOOO@@@@@@@@@@@@@@@@@@OoO@@@@@@@OOOOOOO/o`@]O....      
# ........        .....                   ...         .....,@OOOOOO@@@@@O@=]/[[[@@@@@@@@@OOOOOOO@@OOOOOOOOo/o///`...     
# ..  ...   ..                                    .....,/@@@@@OOO@@@@@@@@\oooooooooooo/o]\\\]]/@@@@OOOOOOO/]@[O`......   
# ##########################################################################################################################

import os
import struct
import argparse
import shutil
import re

old_vs_new = {
    # Stelle
    "f05d06de":"ed04bfc7",
    "b55c8431":"195d016d",
    "f00b6ded":"454c77a5",
    "fba309df":"47695dd6",
    # cellphoneVS
    "7ef7100f66e87ae5":"eec35f974a28be87",
}

replacement_mapping = {
    # Stelle
    "d52d7139": {
        "match_first_index = 32946":"match_first_index = 35661",
    },
}

def normalize_spaces(content):
    """
    规范化空格，将关键字后的多个空格缩减为一个空格
    但保留缩进部分的空格
    """
    # 匹配条件语句中的多余空格
    patterns = [
        r'(if\s+)(ps-t\d+\s+)(==\s+)(\d+)',
        r'(elif\s+)(ps-t\d+\s+)(==\s+)(\d+)',
        r'(else if\s+)(ps-t\d+\s+)(==\s+)(\d+)'
    ]
    
    for pattern in patterns:
        # 使用正则表达式查找并替换多余空格
        matches = re.finditer(pattern, content)
        for match in matches:
            # 将每个捕获组中的多个空格替换为单个空格
            normalized = ' '.join([group.strip() for group in match.groups()])
            content = content.replace(match.group(0), normalized)
    
    return content

def process_conditional_blocks(content):
    """
    处理条件块，添加新的条件判断
    只匹配 ps-t0 和 ps-t1，不匹配更高的数字
    """
    modified = False
    
    # 首先规范化空格
    content = normalize_spaces(content)
    
    # 模式1: if ps-t0 == ##1 ... elif ps-t0 == ##2 ... endif ... if ps-t1 == ##2 ... endif
    pattern1 = re.compile(
        r'^(\s*)if ps-t(0) == (\d{1,4})\s*\n'  # if ps-t0 == ##1 (只匹配0)
        r'((?:.*\n)*?)'  # *1 (非贪婪匹配)
        r'^\1(?:elif|else if) ps-t\2 == (\d{1,4})\s*\n'  # elif/else if ps-t0 == ##2
        r'((?:.*\n)*?)'  # *2
        r'^\1endif\s*\n'  # endif
        r'^\1if ps-t(1) == \4\s*\n'  # if ps-t1 == ##2 (只匹配1)
        r'((?:.*\n)*?)'  # *3
        r'^\1endif\s*$',  # endif
        re.MULTILINE
    )
    
    # 模式2: if ps-t0 == ##1 ... endif ... if ps-t1 == ##2 ... endif
    pattern2 = re.compile(
        r'^(\s*)if ps-t(0) == (\d{1,4})\s*\n'  # if ps-t0 == ##1 (只匹配0)
        r'((?:.*\n)*?)'  # *1
        r'^\1endif\s*\n'  # endif
        r'^\1if ps-t(1) == (\d{1,4})\s*\n'  # if ps-t1 == ##2 (只匹配1)
        r'((?:.*\n)*?)'  # *2
        r'^\1endif\s*$',  # endif
        re.MULTILINE
    )
    
    # 使用集合来跟踪已经处理过的块，避免重复处理
    processed_blocks = set()
    
    # 处理模式1
    for match in pattern1.finditer(content):
        # 获取匹配的完整文本
        full_match = match.group(0)
        
        # 如果这个块已经被处理过，跳过
        if full_match in processed_blocks:
            continue
            
        indent = match.group(1)
        t0_num = int(match.group(2))  # 应该是0
        num1 = match.group(3)
        block1 = match.group(4)
        num2 = match.group(5)
        block2 = match.group(6)
        t1_num = int(match.group(7))  # 应该是1
        block3 = match.group(8)
        
        # 检查是否包含hair，如果包含则跳过
        if 'hair' in block1.lower() or 'hair' in block2.lower() or 'hair' in block3.lower():
            continue
            
        # 生成新的内容
        new_block1 = re.sub(rf'ps-t{t0_num}', f'ps-t{t1_num}', block1)
        new_block2 = re.sub(rf'ps-t{t0_num}', f'ps-t{t1_num}', block2)
        new_block3 = re.sub(rf'ps-t{t1_num}', f'ps-t{t1_num+1}', block3)
        
        new_content = (
            f'{indent}if ps-t{t1_num} == {num1}\n'
            f'{new_block1}'
            f'{indent}elif ps-t{t1_num} == {num2}\n'
            f'{new_block2}'
            f'{indent}endif\n'
            f'{indent}if ps-t{t1_num+1} == {num2}\n'
            f'{new_block3}'
            f'{indent}endif\n'
        )
        
        # 替换原内容
        content = content.replace(full_match, full_match + '\n' + new_content)
        # 标记这个块已经被处理
        processed_blocks.add(full_match)
        modified = True
        print(f" -  Pattern 1 matched and modified: ps-t{t0_num} -> ps-t{t1_num}, ps-t{t1_num} -> ps-t{t1_num+1}")
    
    # 处理模式2
    for match in pattern2.finditer(content):
        # 获取匹配的完整文本
        full_match = match.group(0)
        
        # 如果这个块已经被处理过，跳过
        if full_match in processed_blocks:
            continue
            
        indent = match.group(1)
        t0_num = int(match.group(2))  # 应该是0
        num1 = match.group(3)
        block1 = match.group(4)
        t1_num = int(match.group(5))  # 应该是1
        num2 = match.group(6)
        block2 = match.group(7)
        
        # 检查是否包含hair，如果包含则跳过
        if 'hair' in block1.lower() or 'hair' in block2.lower():
            continue
            
        # 生成新的内容
        new_block1 = re.sub(rf'ps-t{t0_num}', f'ps-t{t1_num}', block1)
        new_block2 = re.sub(rf'ps-t{t1_num}', f'ps-t{t1_num+1}', block2)
        
        new_content = (
            f'{indent}if ps-t{t1_num} == {num1}\n'
            f'{new_block1}'
            f'{indent}endif\n'
            f'{indent}if ps-t{t1_num+1} == {num2}\n'
            f'{new_block2}'
            f'{indent}endif\n'
        )
        
        # 替换原内容
        content = content.replace(full_match, full_match + '\n' + new_content)
        # 标记这个块已经被处理
        processed_blocks.add(full_match)
        modified = True
        print(f" -  Pattern 2 matched and modified: ps-t{t0_num} -> ps-t{t1_num}, ps-t{t1_num} -> ps-t{t1_num+1}")
    
    return content, modified

def process_folder(folder_path):
    '''Process all the files in the folder and subfolders,
    replacing the old values with the new ones.'''
    for root, dirs, files in os.walk(folder_path):
        for file in [x for x in files if x.lower().endswith('.ini') and x.lower() != 'desktop.ini']:
            file_path = os.path.join(root, file)
            print(f"--> Get in file '{file}' at '{file_path}'")
            try:
                with open(file_path, 'r', encoding="utf-8") as f:
                    s = f.read()
                    # old_stream = s
                if '[disabled1234567890]' in s:
                    print(f"Skipping file '{file}' as it already contains '[disabled1234567890]'")
                    continue
                modified = False
                
                # 原有的替换逻辑
                for old, new in old_vs_new.items():
                    if old in s:
                        s = s.replace(old, new)
                        print(f" -  Hash '{old}' has been replase with '{new}'")
                        modified = True
                
                for key, values in replacement_mapping.items():
                    if key in s:
                        for search_string, replace_string in values.items():
                            if search_string not in s:
                                print(f" -  Not contain the specified string '{search_string}'. Skipping current string")
                                continue
                            else:
                                modified = True
                                if callable(replace_string):
                                    strr = replace_string(key)
                                    s += f'\n\n{strr}'
                                    print(f' -  {search_string[:4]}...{search_string[-4:]} --> {strr[:4]}...{strr[-4:]}')
                                else:
                                    s = s.replace(search_string, replace_string)
                                    print(f' -  {search_string[:4]}...{search_string[-4:]} --> {replace_string[:4]}...{replace_string[-4:]}')
                    else:
                        print(f" -  key '{key}' not in")
                
                # 新增的条件块处理逻辑
                s, conditional_modified = process_conditional_blocks(s)
                if conditional_modified:
                    modified = True
                    print(" -  Conditional blocks have been modified")
                
                if modified:
                    backup_file_path = os.path.join(root, f"backup_{os.path.splitext(file)[0]}.txt")
                    shutil.copy2(file_path, backup_file_path)
                    print(f" -  Backup created: '{backup_file_path}'")
                    with open(file_path, 'w', encoding="utf-8") as f:
                        f.write(s)
                        print(f'<-- File has been modified!')
                else:
                    print(f'<-- File had no matches. Skipping')
            except Exception as e:
                print(f'Error processing file: {file_path}')
                print(e)
                continue

if __name__ == '__main__':
    process_folder(os.getcwd())
    input('Done!')